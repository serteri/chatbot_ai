// Education-Focused Chatbot Platform - Complete Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  password      String?

  // Company info
  companyName String?
  website     String?

  // Settings
  language           String  @default("tr")
  timezone           String  @default("Europe/Istanbul")
  stripeCustomerId   String? @unique
  emailNotifications Boolean @default(true)
  notificationEmail  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts                Account[]
  sessions                Session[]
  chatbots                Chatbot[]
  subscription            Subscription?
  teamMembers             TeamMember[]
  templatePurchases       TemplatePurchase[]
  templateReviews         TemplateReview[]
  studentProfile          StudentProfile?
  scholarshipApplications ScholarshipApplication[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Plan
  planType String @default("free") // free, starter, professional, enterprise
  status   String @default("active") // active, canceled, past_due

  // Limits
  maxChatbots       Int @default(1)
  maxDocuments      Int @default(10)
  maxConversations  Int @default(100)
  conversationsUsed Int @default(0)
  storageLimit      Int @default(100) // MB
  storageUsed       Int @default(0)

  // Period
  currentPeriodStart DateTime  @default(now())
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  lastResetDate      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================
// CHATBOT TEMPLATES
// ============================================

model ChatbotTemplate {
  id String @id @default(cuid())

  // Template Info
  name        String
  slug        String @unique
  description String @db.Text
  category    String // "education", "ecommerce", "support", "healthcare"

  // Pricing
  price    Float  @default(0)
  currency String @default("USD")

  // Content
  icon      String?
  thumbnail String?
  features  String[]

  // Template Data
  systemPrompt     String   @db.Text
  welcomeMessages  Json
  fallbackMessages Json
  sampleQuestions  String[]

  // Configuration
  defaultSettings      Json?
  requiredIntegrations String[]

  // Database Content
  includesUniversities Boolean @default(false)
  includesScholarships Boolean @default(false)
  includesFAQs         Boolean @default(false)

  // SEO & Marketing
  isActive   Boolean  @default(true)
  isFeatured Boolean  @default(false)
  popularity Int      @default(0)
  tags       String[]

  // Analytics
  totalSales   Int    @default(0)
  totalRevenue Float  @default(0)
  avgRating    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  purchases TemplatePurchase[]
  reviews   TemplateReview[]

  @@index([category])
  @@index([slug])
  @@index([isActive])
}

model TemplatePurchase {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  templateId String
  template   ChatbotTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  chatbotId String?
  chatbot   Chatbot? @relation(fields: [chatbotId], references: [id], onDelete: SetNull)

  // Payment
  amount          Float
  currency        String
  stripePaymentId String? @unique

  status String @default("completed") // pending, completed, refunded

  // Usage
  isApplied Boolean   @default(false)
  appliedAt DateTime?

  purchasedAt DateTime @default(now())

  @@index([userId])
  @@index([templateId])
  @@index([chatbotId])
}

model TemplateReview {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  templateId String
  template   ChatbotTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  rating  Int // 1-5
  comment String? @db.Text

  isVerifiedPurchase Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, templateId])
  @@index([templateId])
}

// ============================================
// CHATBOT
// ============================================

model Chatbot {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Info
  name       String
  identifier String @unique

  // Appearance
  primaryColor   String  @default("#3b82f6")
  secondaryColor String  @default("#1e40af")
  botAvatar      String?
  botName        String  @default("AI Assistant")
  position       String  @default("bottom-right")

  // Multi-language Bot Names
  botNameTr String @default("AI Asistan")
  botNameEn String @default("AI Assistant")
  botNameDe String @default("KI-Assistent")
  botNameFr String @default("Assistant IA")
  botNameEs String @default("Asistente IA")

  // Template
  appliedTemplateId String?
  templatePurchases TemplatePurchase[]

  // Multi-language Messages
  welcomeMessageTr String @default("Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim?")
  welcomeMessageEn String @default("Hello! How can I help you?")
  welcomeMessageDe String @default("Hallo! Wie kann ich Ihnen helfen?")
  welcomeMessageFr String @default("Bonjour! Comment puis-je vous aider?")
  welcomeMessageEs String @default("Â¡Hola! Â¿CÃ³mo puedo ayudarte?")

  fallbackMessageTr String @default("ÃœzgÃ¼nÃ¼m, bu konuda yardÄ±mcÄ± olamÄ±yorum.")
  fallbackMessageEn String @default("Sorry, I cannot help with that.")
  fallbackMessageDe String @default("Entschuldigung, dabei kann ich nicht helfen.")
  fallbackMessageFr String @default("DÃ©solÃ©, je ne peux pas vous aider avec Ã§a.")
  fallbackMessageEs String @default("Lo siento, no puedo ayudar con eso.")

  placeholderTr String @default("MesajÄ±nÄ±zÄ± yazÄ±n...")
  placeholderEn String @default("Type your message...")
  placeholderDe String @default("Geben Sie Ihre Nachricht ein...")
  placeholderFr String @default("Ã‰crivez votre message...")
  placeholderEs String @default("Escribe tu mensaje...")

  // Legacy Messages (for backward compatibility)
  welcomeMessage  String  @default("Hello! How can I help you today?")
  placeholderText String  @default("Type your message...")
  fallbackMessage String  @default("I couldn't find an answer. Would you like to speak with a human?")
  offlineMessage  String?

  // Behavior
  language      String @default("en")
  aiModel       String @default("gpt-3.5-turbo")
  temperature   Float  @default(0.7)
  responseStyle String @default("professional")

  // Widget Customization
  widgetPrimaryColor String  @default("#3B82F6")
  widgetButtonColor  String  @default("#2563EB")
  widgetTextColor    String  @default("#FFFFFF")
  widgetPosition     String  @default("bottom-right")
  widgetSize         String  @default("medium")
  widgetLogoUrl      String?
  widgetBubbleIcon   String  @default("bot")

  // Features
  enableLiveChat     Boolean @default(true)
  enableEmailCapture Boolean @default(true)
  enableRating       Boolean @default(true)
  enableSources      Boolean @default(true)

  // Integration
  allowedDomains    String[] @default([])
  liveChatWebhook   String?
  emailNotification String?

  // Live Support
  whatsappNumber String?
  supportEmail   String?
  liveSupport    Boolean @default(false)
  liveSupportUrl String?

  // Industry & Settings
  industry       String  @default("general") // "education", "ecommerce", "general"
  customSettings Json?
  model          String?

  // Status
  isActive    Boolean @default(true)
  isPublished Boolean @default(false)

  // Analytics
  totalConversations Int    @default(0)
  totalMessages      Int    @default(0)
  avgRating          Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  documents          Document[]
  conversations      Conversation[]
  analytics          ChatbotAnalytics[]
  liveSupportRequest LiveSupportRequest[]

  @@index([userId])
  @@index([identifier])
}

// ============================================
// DOCUMENTS (Knowledge Base)
// ============================================

model Document {
  id        String  @id @default(cuid())
  chatbotId String
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  // File Info
  name String
  type String // "pdf", "docx", "txt", "url", "markdown"
  url  String?
  size Int?

  // Processing
  status       String  @default("processing") // processing, ready, failed
  errorMessage String?

  // Content
  rawContent  String? @db.Text
  totalChunks Int     @default(0)
  totalTokens Int     @default(0)
  content     String? @db.Text
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chunks DocumentChunk[]

  @@index([chatbotId])
  @@index([status])
}

model DocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Content
  content String @db.Text

  // Embedding (Vector)
  embedding Bytes?

  // Metadata
  chunkIndex Int
  tokenCount Int
  pageNumber Int?

  createdAt DateTime @default(now())

  @@index([documentId])
}

// ============================================
// CONVERSATIONS
// ============================================

model Conversation {
  id        String  @id @default(cuid())
  chatbotId String
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  // Visitor Info
  visitorId    String
  visitorEmail String?
  visitorName  String?
  visitorPhone String?

  // Status
  status   String  @default("active") // active, resolved, escalated, spam
  rating   Int?
  feedback String? @db.Text

  // Session Info
  userAgent   String?
  ipAddress   String?
  country     String?
  referrer    String?
  currentPage String?

  // Timestamps
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  updatedAt DateTime  @updatedAt
  createdAt DateTime  @default(now())

  // Relations
  messages           ConversationMessage[]
  liveSupportRequest LiveSupportRequest[]

  @@index([chatbotId])
  @@index([visitorId])
  @@index([status])
  @@index([startedAt])
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Message
  role    String // "user", "assistant", "system"
  content String @db.Text

  // AI Response metadata
  aiModel    String?
  tokens     Int?
  confidence Float?

  // Sources
  sources Json?

  // Human takeover
  isHumanResponse Boolean @default(false)
  humanAgentId    String?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// ============================================
// ANALYTICS
// ============================================

model ChatbotAnalytics {
  id        String  @id @default(cuid())
  chatbotId String
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  date DateTime @db.Date

  // Metrics
  totalConversations Int @default(0)
  totalMessages      Int @default(0)
  uniqueVisitors     Int @default(0)

  resolvedByAI     Int @default(0)
  escalatedToHuman Int @default(0)

  avgConfidence         Float?
  avgRating             Float?
  avgResponseTime       Int?
  avgConversationLength Int?

  // Top queries
  topQueries Json?

  @@unique([chatbotId, date])
  @@index([date])
}

// ============================================
// TEAM COLLABORATION
// ============================================

model TeamMember {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitedBy String
  role      String @default("member") // owner, admin, member, viewer

  joinedAt DateTime @default(now())

  @@index([userId])
}

// ============================================
// EDUCATION: UNIVERSITIES & SCHOLARSHIPS
// ============================================

model University {
  id                String   @id @default(cuid())
  name              String
  country           String
  city              String
  ranking           Int?
  tuitionMin        Float?
  tuitionMax        Float?
  programs          String[]
  programEmbeddings Json?
  requirements      Json?
  website           String?
  description       String?  @db.Text
  type              String? // Public, Private
  tuitionFee        String? // Text field for flexible formatting

  logo                  String?
  founded               Int?
  studentCount          Int?
  internationalStudents Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - SCHOLARSHIP Ä°LÄ°ÅžKÄ°SÄ°NÄ° KALDIRDIK
  wishlistedBy UniversityWishlist[]
  applications Application[]

  @@index([country])
  @@index([ranking])
}

// ============================================
// EDUCATION: VISA & LANGUAGE
// ============================================

model VisaInfo {
  id             String  @id @default(cuid())
  country        String
  visaType       String
  duration       String
  cost           Int?
  requirements   Json
  processingTime String
  multiLanguage  Json
  website        String?
  description    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country])
}

model LanguageSchool {
  id             String   @id @default(cuid())
  name           String
  country        String
  city           String?
  languages      String[]
  courseDuration String
  pricePerWeek   Int?
  intensity      String?
  accommodation  Boolean  @default(false)
  certifications String[]
  website        String?
  description    String?
  multiLanguage  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country])
  @@index([languages])
}

model CostOfLiving {
  id            String @id @default(cuid())
  country       String
  city          String
  rent          Int?
  food          Int?
  transport     Int?
  utilities     Int?
  insurance     Int?
  miscellaneous Int?
  total         Int
  currency      String @default("USD")
  multiLanguage Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([country, city])
  @@index([country])
}

model ApplicationGuide {
  id            String   @id @default(cuid())
  country       String
  title         String
  steps         Json
  timeline      String
  documents     String[]
  tips          String[]
  deadlines     Json?
  multiLanguage Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country])
}

// ============================================
// ðŸŽ“ STUDENT DASHBOARD
// ============================================

model StudentProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Info
  firstName      String
  lastName       String
  dateOfBirth    DateTime?
  nationality    String?
  phoneNumber    String?
  currentCountry String?
  currentCity    String?

  // Academic Background
  highestDegree  String? // High School, Bachelor's, Master's
  fieldOfStudy   String?
  gpa            Float?
  graduationYear Int?
  institution    String?

  // Test Scores
  toeflScore Int?
  ieltsScore Float?
  satScore   Int?
  greScore   Int?
  gmatScore  Int?

  // Preferences
  preferredCountries String[]
  preferredCities    String[]
  preferredFields    String[]
  budgetMin          Int? // USD per year
  budgetMax          Int?
  intakeYear         Int? // 2025, 2026
  intakeSemester     String? // Fall, Spring, Summer

  // Additional
  workExperience      String? // Years
  hasScholarship      Boolean @default(false)
  needsVisa           Boolean @default(true)
  languageProficiency Json? // { english: 'Advanced', german: 'Beginner' }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  wishlist     UniversityWishlist[]
  applications Application[]

  @@index([userId])
}

model UniversityWishlist {
  id           String         @id @default(cuid())
  studentId    String
  student      StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  universityId String
  university   University     @relation(fields: [universityId], references: [id], onDelete: Cascade)

  notes    String?
  priority Int     @default(1) // 1 = High, 2 = Medium, 3 = Low

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, universityId])
  @@index([studentId])
  @@index([universityId])
}

model Application {
  id           String         @id @default(cuid())
  studentId    String
  student      StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  universityId String
  university   University     @relation(fields: [universityId], references: [id], onDelete: Cascade)

  // Application Details
  program String // Computer Science, MBA, etc.
  degree  String // Bachelor's, Master's, PhD
  intake  String // Fall 2025, Spring 2026

  // Status
  status    String    @default("draft") // draft, submitted, under_review, accepted, rejected, waitlisted
  appliedAt DateTime?
  decidedAt DateTime?
  deadline  DateTime?

  // Documents
  documents Json? // { transcript: true, lor: false, sop: true }

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([universityId])
  @@index([status])
}

// ============================================
// LIVE SUPPORT
// ============================================

model LiveSupportRequest {
  id        String  @id @default(cuid())
  chatbotId String
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  visitorId String
  email     String?
  phone     String?
  message   String  @db.Text
  status    String  @default("pending") // pending, contacted, resolved
  priority  String  @default("normal") // low, normal, high

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatbotId])
  @@index([status])
}

// ============================================
// ðŸŽ“ SCHOLARSHIP SYSTEM (YENÄ°)
// ============================================

model Scholarship {
  id          String @id @default(cuid())
  title       String
  description String @db.Text
  provider    String // "Government", "University", "Private"
  amount      String // "$5,000", "Full tuition", etc.
  currency    String @default("USD")

  // Eligibility
  minGPA       Float?
  maxAge       Int?
  nationality  String[] // ["Turkey", "EU", "Any"]
  studyLevel   String[] // ["Bachelor", "Master", "PhD"]
  fieldOfStudy String[] // ["Engineering", "Medicine", etc.]

  // Application info
  deadline       DateTime
  startDate      DateTime?
  endDate        DateTime?
  applicationUrl String?
  requirements   String[] // ["Transcript", "Letter of recommendation", etc.]

  // Location (STRING olarak, iliÅŸki yok)
  country      String
  city         String?
  universities String[] // University names/IDs as strings

  // Metadata
  isActive  Boolean  @default(true)
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  externalId   String?                  @unique
  source       String?
  lastSynced   DateTime?
  // Relations
  applications ScholarshipApplication[]

  @@index([country])
  @@index([deadline])
  @@index([provider])
  @@index([studyLevel])
  @@index([source]) // ðŸ†• New index for API sources
  @@index([externalId]) // ðŸ†• New index for external IDs
}

model ScholarshipApplication {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  scholarshipId String
  scholarship   Scholarship @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)

  // Application status
  status      String    @default("draft") // draft, submitted, under_review, accepted, rejected
  appliedAt   DateTime?
  lastUpdated DateTime  @updatedAt

  // Application data
  personalStatement String? @db.Text
  documents         Json? // {"transcript": "url", "recommendation": "url"}
  notes             String? @db.Text

  // Timeline tracking
  milestones Json? // [{"date": "2025-01-15", "event": "Application submitted"}]

  createdAt DateTime @default(now())

  @@unique([userId, scholarshipId])
  @@index([userId])
  @@index([status])
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin: 10px 0;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        .result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
<div class="card">
    <h1>🔒 Domain Test Sayfası</h1>
    <p>Chatbot widget'ınızın domain kontrolünü test edin</p>

    <div class="info">
        <strong>📍 Current Domain:</strong> <code id="currentDomain">Loading...</code><br>
        <strong>📍 Origin:</strong> <code id="currentOrigin">Loading...</code>
    </div>

    <label><strong>Chatbot ID:</strong></label>
    <input type="text" id="chatbotId" placeholder="PTP2l7aNOvlG" value="PTP2l7aNOvlG">

    <label><strong>Test Mesajı:</strong></label>
    <input type="text" id="testMessage" placeholder="Merhaba" value="Merhaba">

    <button onclick="testWidget()">🚀 Test Et</button>

    <div id="result" class="result"></div>
</div>

<div class="card">
    <h3>📋 Test Senaryoları</h3>
    <ul>
        <li>✅ <strong>Allowed Domain:</strong> Widget çalışır</li>
        <li>❌ <strong>Blocked Domain:</strong> 403 Forbidden hatası</li>
        <li>🏠 <strong>Localhost:</strong> Development'ta otomatik izin</li>
        <li>🔓 <strong>Empty List:</strong> Tüm domainler kabul edilir</li>
    </ul>
</div>

<script>
    // Current domain bilgilerini göster
    document.getElementById('currentDomain').textContent = window.location.hostname;
    document.getElementById('currentOrigin').textContent = window.location.origin;

    async function testWidget() {
        const chatbotId = document.getElementById('chatbotId').value;
        const message = document.getElementById('testMessage').value;
        const resultDiv = document.getElementById('result');

        if (!chatbotId || !message) {
            showResult('error', '❌ Lütfen tüm alanları doldurun');
            return;
        }

        resultDiv.className = 'result show';
        resultDiv.innerHTML = '⏳ Test ediliyor...';

        try {
            const response = await fetch('/api/public/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chatbotId: chatbotId,
                    message: message,
                    visitorId: 'test_' + Date.now(),
                }),
            });

            if (response.ok) {
                showResult('success', `✅ BAŞARILI! Domain izin verilmiş (Status: ${response.status})`);
            } else if (response.status === 403) {
                const data = await response.json();
                showResult('error', `🚫 REDDEDILDI! ${data.error}`);
            } else {
                const data = await response.json();
                showResult('error', `❌ HATA: ${data.error} (Status: ${response.status})`);
            }

        } catch (error) {
            showResult('error', `❌ BAĞLANTI HATASI: ${error.message}`);
        }
    }

    function showResult(type, message) {
        const resultDiv = document.getElementById('result');
        resultDiv.className = `result ${type} show`;
        resultDiv.innerHTML = message;
    }

    // Enter ile test
    document.getElementById('testMessage').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') testWidget();
    });
</script>
</body>
</html>